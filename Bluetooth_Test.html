<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0" content=text/html;charset=UTF-8 meta http-equiv="Content-Type"/>

<style>
    body,head {
        /*color:#666;*/
        background-color:#eee;
        font:20px "Roboto", sans-serif;
        -webkit-font-smoothing:antialiased;
    }
</style>

<html>
    <head>
        
    </head>
   
    <body>
        <p align="center"><button id="scan" class="buttons">Scan Device</button></p>
        <p align="center"><button id="printtext" class="buttons">Print Text</button></p>
        <p align="center"><input id="file" type="file"></p> <!--onchange="onImageChange(event)-->
        <p align="center"><button id="printimage" class="buttons">Print File</button></p>
        <p align="center"><button id="disconnect" class="buttons">Disconnect Device</button></p>
        <p align="center"><img  id="logo" src="./img/woosim.bmp"></p>
        <br/><br/><br/><br/><p align="center" id="debug">Debug Text</p>
        
        <script type="text/javascript" charset="utf-8">
        
        let connect = document.querySelector('#scan');
        let printtext = document.querySelector('#printtext');
        let printimage = document.querySelector('#printimage');
        let disconnect = document.querySelector('#disconnect');
        let debug = document.querySelector('#debug');
        let logo = document.querySelector('#logo');
        let printCharacteristic = null;
        let BluetoothDevice = null;
        let image = null;
        
        // 한번에 보낼수있는 max length = 45
        let AtoZ = new Uint8Array([0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4A,0x4B,0x4C,0x4D,
                                   0x4E,0x4F,0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5A]);
        let GAtoHA = new Uint8Array([0xB0,0xA1,0xB3,0xAA,0xB4,0xD9,0xB6,0xF3,0xB8,0xB6,0xB9,0xD9,0xBB,0xE7,
                                     0xBE,0xC6,0xC0,0xDA,0xC2,0xF7,0xC4,0xAB,0xC5,0xB8,0xC6,0xC4,0xC7,0xCF]);
        let ONEtoZERO = new Uint8Array([0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30]);
        let woosim = new Uint8Array([0x57, 0x6F, 0x6F, 0x73, 0x69, 0x6D, 0x20, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D]); // text "Woosim System"
        let test = new Uint8Array([0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x74, 0x65, 0x73, 0x74, 0x2E]); // text "This is test."
        
        let LF = new Uint8Array([0x0A]); // Print and Line feed
        let initialize = new Uint8Array([0x1B, 0x40]); // Initialize printer. ESC @
        let pagemode = new Uint8Array([0x1B, 0x4C]); // Select page mode. ESC L
        let FF = new Uint8Array([0x0C]); // Print and return to standard mode in page mode. FF
        let area = new Uint8Array([0x1B, 0x57, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x80, 0x01]); // Set printing area in page mode.
        let bitcommand1 = new Uint8Array([0x1B, 0x58, 0x34, 0x02, 0x14]); // ESC X 4 x y d1 ~ dk // Define user-defined bit-image.
        
        /* 2022.04.11 불러오기를 통해 불러온 file을 array buffer형식으로 읽어오는 test코드 */
        document.querySelector('#file').addEventListener('change', function(e) {
            let file = e.target.files;
            console.log(file[0]);
            var reader = new FileReader();
            reader.readAsArrayBuffer(e.target.files[0]);
            reader.onload = function(e) {
                console.log(e.target.result);
                console.log(reader);
                reader.result = new ArrayBuffer(reader.length);
                console.log(reader.result);
                image = new Uint8Array(reader.result);
                console.log(image);
                console.log(image.length);
            }
        });
        
        async function PrintImage() {
            let index=0;
            await printCharacteristic.writeValue(initialize);
            // 한번에 보낼수있는 max length = 45
            while (index + 45 < image.length) {
                let temp = image.slice(index, index + 45);
                await printCharacteristic.writeValue(temp)
                    .then(() => {
                        this.delayPromise(100);
                        console.log(temp);
                        index += 45;
                    })
                    .catch(error => { 
                        console.log(error);
                        debug.innerText = error;
                    });
            } console.log(index);
            
            if (index < image.length) {
                let temp = image.slice(index, image.length);
                await printCharacteristic.writeValue(temp)
                    .then(() => {
                        this.delayPromise(100);
                        console.log(temp);
                    })
                    .catch(error => { 
                        console.log(error);
                        debug.innerText = error;
                    });
            } await printCharacteristic.writeValue(LF);
        }
        /* ~~ 2022.04.11 image test 불러오기를 통해 불러온 file을 array buffer형식으로 읽어오는 test코드*/
            
        connect.addEventListener('click', function() { // Scan Button Click
            debug.innerText = 'Scanning the device...';
            console.log('Scanning the device...');
            navigator.bluetooth.requestDevice({ // Scan Device
                //acceptAllDevices: true, // No Use Filter. All Device Scan.
                filters: [{name:'WOOSIM-BLE'}], // Name Filter: 'WOOSIM-BLE'에 해당하는 Device Scan
                optionalServices: ['a9fe5e12-de71-4020-b2cf-8bf764fb0a8d'] // Printer Service UUID
            })
            .then(device => {
                BluetoothDevice = device;
                console.log('Connecting the device...');
                return BluetoothDevice.gatt.connect();
            })
            .then(server => {
                debug.innerText = 'Connection Success.';
                console.log('gatt.connect() success');
                console.log('gatt.connected : ' + BluetoothDevice.gatt.connected);
                console.log('device.name    : ' + BluetoothDevice.name);
                console.log('device.id      : ' + BluetoothDevice.id);
                console.log('server.getPrimaryService...');
                return server.getPrimaryService('a9fe5e12-de71-4020-b2cf-8bf764fb0a8d');
            })
            .then(service => {
                console.log('service.getCharacteristic...');
                return service.getCharacteristic('a9fe5e12-de71-4020-b2cf-8bf766fb0a8d');
            })
            .then(characteristic => {
                console.log('characteristic and send text data');
                printCharacteristic = characteristic;
                // sendTextData1(); // 연결되면 text "Woosim System" 출력
            })
            .catch(error => {
                console.log(error);
                debug.innerText = error;
            });
        });
            
        async function sendTextData1() { // Print text "Woosim System"
          await printCharacteristic.writeValue(woosim);
          await printCharacteristic.writeValue(LF)
            .then(() => this.delayPromise(100))
            .catch(error => { 
                console.log(error);
                debug.innerText = error;
            });
        }
            
        printtext.addEventListener('click', function() {
            sendTextData2();
        });
        printimage.addEventListener('click', function() {
            PrintImage();
        });
                               
        async function sendTextData2() { // Print text "This is test."
          await printCharacteristic.writeValue(test).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(LF).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(GAtoHA).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(LF).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(AtoZ).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(LF).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(ONEtoZERO).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(LF).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(LF).then(() => this.delayPromise(100));
          await printCharacteristic.writeValue(LF)
            .then(() => this.delayPromise(100))
            .catch(error => { 
                console.log(error);
                debug.innerText = error;
            });
        }
            
        function delayPromise(delay) {
            return new Promise(resolve => {
                setTimeout(resolve, delay);
            });
        }
            
        disconnect.addEventListener('click', function() { // Disconnect Button Click
            console.log(BluetoothDevice);
            if(!BluetoothDevice) {
                debug.innerText = 'No device connected.';
                console.log('No device connected.');
            }
            console.log('Disconnecting the device...');
            if(BluetoothDevice.gatt.connected) {
                BluetoothDevice.gatt.disconnect();
                debug.innerText = 'Disconnect the device.';
                console.log('Disconnect the device.');
            } else {
                debug.innerText = 'Bluetooth Device is already disconnected';
                console.log('Bluetooth Device is already disconnected');
            }
        });
            
        </script>
    </body>
</html>
